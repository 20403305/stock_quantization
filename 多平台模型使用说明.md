# 多平台模型使用说明

## 功能概述

本系统现在支持多个AI模型平台，包括：
- **本地模型服务** - 默认启用，使用本地部署的模型
- **深度求索平台** - 支持在线API调用

## 配置方法

### 1. 环境变量配置

复制 `.env.example` 文件为 `.env`，并配置以下参数：

```bash
# 模型配置 - 本地服务
LOCAL_MODEL_ENDPOINT=http://192.168.101.31:13888/api
LOCAL_MODEL_KEY=sk-8665ae17a16d4345b907ecde63d0b2ab
LOCAL_DEFAULT_MODEL=deepseek-r1:1.5b

# 模型配置 - 深度求索平台
DEEPSEEK_API_ENDPOINT=https://api.deepseek.com/v1
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_DEFAULT_MODEL=deepseek-chat
DEEPSEEK_ENABLED=False

# 通用模型配置
DEFAULT_MODEL_PLATFORM=local
MODEL_MAX_TOKENS=4096
MODEL_TEMPERATURE=0.7
MODEL_TIMEOUT=60
```

### 2. 启用深度求索平台

要启用深度求索平台，需要：
1. 获取深度求索API密钥
2. 在 `.env` 文件中设置：
   ```
   DEEPSEEK_API_KEY=你的实际API密钥
   DEEPSEEK_ENABLED=True
   ```

### 3. 切换默认平台

修改 `DEFAULT_MODEL_PLATFORM` 环境变量：
- `local` - 使用本地模型服务（默认）
- `deepseek` - 使用深度求索平台

## 前端使用

### 数据源选择界面

在Web应用的侧边栏中，可以看到：

1. **数据源选择**：
   - Tushare（默认）- 支持A股数据
   - Yahoo Finance - 支持全球股票数据
   - AKShare - 支持多种数据源

2. **股票选择**：
   - 输入股票代码（如600519）
   - 自动显示股票名称（如贵州茅台）

3. **模型平台选择**（启用AI模型分析后）：
   - 本地模型服务（默认）
   - 深度求索平台

4. **模型选择**：
   - 本地平台：deepseek-r1:1.5b、deepseek-r1:7b、deepseek-r1:14b
   - 深度求索平台：deepseek-chat、deepseek-coder

### 使用流程

1. 选择数据源（默认为Tushare）
2. 输入股票代码，系统自动显示股票名称
3. 设置时间范围和策略参数
4. 在侧边栏勾选"启用AI模型分析"（可选）
5. 选择模型平台和具体模型（可选）
6. 点击"运行回测"或"仅运行模型分析"

### 股票名称显示

系统会自动识别股票代码并显示对应的股票名称：
- 600519 → 贵州茅台
- 000001 → 平安银行
- 000858 → 五粮液
- 等常见A股股票

对于不常见的股票代码，系统会尝试从数据源获取名称，如果无法获取则显示原始代码。

## 功能特点

### 1. 平台切换
- 支持运行时切换不同模型平台
- 每个平台有独立的配置和模型选项

### 2. 智能回退
- 如果选择的平台不可用，会自动回退到默认平台
- 连接失败时会使用演示模式继续分析

### 3. 缓存机制
- 分析结果会自动缓存，提高响应速度
- 相同参数的分析会直接使用缓存结果

## 故障排除

### 1. 模型平台选择问题
**问题**：前端选择了深度求索平台，但后台日志显示还是使用本地请求平台。

**解决方案**：
- 已修复：前端现在正确传递模型平台参数到后端
- 系统会根据用户选择动态切换模型平台
- 检查模型平台配置是否正确启用

### 2. 重复请求问题
**问题**：同一个股票代码、时间范围和模型会重复请求AI分析。

**解决方案**：
- 已实现智能缓存机制
- 相同参数的请求会自动使用缓存结果
- 支持强制刷新（勾选"强制刷新"选项）

### 3. 数据源问题
如果数据获取失败：
- **Tushare**：检查Tushare Token配置
- **Yahoo Finance**：检查网络连接和证书配置
- **AKShare**：检查网络连接和数据源可用性

### 4. 连接问题
如果出现连接错误：
- 检查网络连接
- 验证API端点配置
- 确认API密钥有效性

### 5. 平台不可用
如果某个平台不可用：
- 系统会自动回退到默认平台
- 检查平台是否已启用（DEEPSEEK_ENABLED=True）

### 6. 股票名称显示问题
如果股票名称无法显示：
- 检查股票代码格式是否正确
- 确认数据源是否支持该股票
- 系统内置了常见A股股票的名称映射

### 7. 性能优化
- 调整 `MODEL_TIMEOUT` 参数控制超时时间
- 修改 `MODEL_MAX_TOKENS` 控制响应长度
- 选择合适的数据源提高数据获取速度
- 利用缓存机制减少重复请求

## 注意事项

1. **API费用**：使用深度求索平台会产生API调用费用
2. **网络要求**：深度求索平台需要稳定的网络连接
3. **数据安全**：确保API密钥安全，不要泄露
4. **兼容性**：不同平台的模型输出格式可能略有差异

## 技术支持

如有问题，请检查：
1. 环境变量配置是否正确
2. 网络连接是否正常
3. API密钥是否有效
4. 平台服务是否可用